{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "26a6643f-3d3c-4cf4-99c7-32ddd5a4ec0a",
   "metadata": {},
   "source": [
    "# HDF5 + mongoDB\n",
    "\n",
    "This databases uses `pymongo` as the backend database. Only meta data (or part of it) is stored in the database, not the raw data. To understand how dataset raw data is linked to the database see the respective chapter in this document."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1e3c96fc-62ac-4462-8e87-d131aeb52c53",
   "metadata": {},
   "outputs": [],
   "source": [
    "import pymongo\n",
    "from pymongo import MongoClient\n",
    "\n",
    "from h5rdmtoolbox import tutorial\n",
    "import h5rdmtoolbox as h5tbx\n",
    "\n",
    "import numpy as np\n",
    "\n",
    "from pprint import pprint\n",
    "\n",
    "h5tbx.__version__"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d13b2108-f659-495c-84f0-db7a206acfdb",
   "metadata": {},
   "source": [
    "## First things first: Connection to the DB:\n",
    "Connect to the mongod client:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b40e8640-b166-4792-913b-6ce39765eef4",
   "metadata": {},
   "outputs": [],
   "source": [
    "client = MongoClient()\n",
    "client"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1b4f6cf9-bcfb-4f24-9052-303bdfcd0515",
   "metadata": {},
   "source": [
    "Create a database and a (test) collection named \"digits\":"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a8f3cb21-e1e3-4969-9103-a48ac49547b9",
   "metadata": {},
   "outputs": [],
   "source": [
    "db = client['h5database_notebook_tutorial']\n",
    "collection = db['digits']\n",
    "\n",
    "# drop all content in order to start from scratch:\n",
    "collection.drop()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9417ee13-271e-43aa-9a23-7dee3c296ff7",
   "metadata": {},
   "source": [
    "## Testdata\n",
    "We will take test data from scikit-learn, namely the hand-written digits ((https://scikit-learn.org/stable/auto_examples/classification/plot_digits_classification.html):"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "39a40ef7-e186-4bdb-ac3e-427e61f9bbc8",
   "metadata": {},
   "outputs": [],
   "source": [
    "# !pip install scikit-learn\n",
    "# !pip install scikit-image"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "111e3c0d-6d5d-4931-9aac-e4f9e6575088",
   "metadata": {},
   "outputs": [],
   "source": [
    "from sklearn.datasets import load_digits\n",
    "digits = load_digits()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "52d15e57-0fac-4c5c-8570-9aaba55f7fbe",
   "metadata": {},
   "source": [
    "Fill a HDF5 file with the loaded data. We additionally compute the mean count and two gray occurance properties (dissimilarity and correlation). Those three datasets together with the true digit of the image are linked to the image via HDF dimension scales:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3c7f5e27-c173-4a14-941c-2614466219a5",
   "metadata": {},
   "outputs": [],
   "source": [
    "from skimage.feature import graycomatrix, graycoprops\n",
    "\n",
    "filename = h5tbx.generate_temporary_filename()\n",
    "\n",
    "with h5tbx.H5File(filename, 'w') as h5:\n",
    "    ds_trg = h5.create_dataset('digit', data=digits.target, units='', long_name='true digit', make_scale=True)\n",
    "    ds_img = h5.create_dataset('images', shape=(len(digits.images), 8, 8), units='pixel', long_name='image of hand-written digit')\n",
    "    \n",
    "    ds_mean = h5.create_dataset('mean', shape=(len(digits.images), ), units='counts', long_name='mean counts of the image', make_scale=True)\n",
    "    ds_diss = h5.create_dataset('dissimilarity', shape=(len(digits.images), ), units='counts', long_name='dissimilarity', make_scale=True)\n",
    "    ds_corr = h5.create_dataset('correlation', shape=(len(digits.images), ), units='counts', long_name='correlation', make_scale=True)\n",
    "    \n",
    "    \n",
    "    for i, img in enumerate(digits.images):\n",
    "        ds_img[i, :, :] = img\n",
    "        ds_mean[i] = np.mean(img)\n",
    "        \n",
    "        glcm = graycomatrix(img.astype(int), distances=[5], angles=[0], levels=256,\n",
    "                            symmetric=True, normed=True)\n",
    "        ds_diss[i] = graycoprops(glcm, 'dissimilarity')[0, 0]\n",
    "        ds_corr[i] = graycoprops(glcm, 'correlation')[0, 0]\n",
    "        \n",
    "    ds_img.dims[0].attach_scale(ds_trg)\n",
    "    ds_img.dims[0].attach_scale(ds_mean)\n",
    "    ds_img.dims[0].attach_scale(ds_diss)\n",
    "    ds_img.dims[0].attach_scale(ds_corr)\n",
    "    h5.dump()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3410054e-7640-4c2e-ada3-fa7ea8b99e60",
   "metadata": {},
   "source": [
    "## Filling the database\n",
    "\n",
    "To insert data from the HDF5 file into the DB, we need the accessor \"mongo\":"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "16c8fddc-d3f2-4987-925f-db07a1337b8b",
   "metadata": {},
   "outputs": [],
   "source": [
    "from h5rdmtoolbox.database import mongo"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "40d84010-8add-4b34-b090-64340880bcf9",
   "metadata": {},
   "outputs": [],
   "source": [
    "with h5tbx.H5File(filename) as h5:\n",
    "    h5['images'].mongo.insert(0, collection)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "20dbda05-96e7-4013-897d-ce8158e967b6",
   "metadata": {},
   "source": [
    "### Find one:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3764848c-5c4f-419c-83ed-fde5bf108d0c",
   "metadata": {},
   "outputs": [],
   "source": [
    "one_res = collection.find_one({'digit': {'$eq': 3}})\n",
    "one_res"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "85f75a65-43ee-410a-a739-39f225494d7f",
   "metadata": {},
   "source": [
    "We found one entry only because we asked for one only. Note, that the sult dictionary provides a \"slice\" entry. This is the slice within the 3D array in the HDF file. We can use this to slice the array. There is even a method in the accessor to simplify this:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f4ea45f8-d056-472b-a003-4e8530fcc45d",
   "metadata": {},
   "outputs": [],
   "source": [
    "with h5tbx.H5File(filename) as h5:\n",
    "    h5.images.mongo.slice(one_res['slice']).plot(cmap='gray')"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d429f56e-1dc8-475a-aaa3-dc34c757167e",
   "metadata": {},
   "source": [
    "## Find many:\n",
    "\n",
    "Let' query a rang of data. Mean count shall be above 5 counts and the digit is >3 and <=8:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6a6c0e55-69b3-408e-8767-2c7c41673c95",
   "metadata": {},
   "outputs": [],
   "source": [
    "collection.count_documents({'mean': {'$gt': 5}, 'digit': {'$gt': 3}, 'digit': {'$lte': 8}})\n",
    "many_res = collection.find({'mean': {'$gt': 5}, 'digit': {'$gt': 3}, 'digit': {'$lte': 8}})"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "69e6344e-fa55-4b9d-93c7-3e65dae22369",
   "metadata": {},
   "source": [
    "Inspect the result by the help of pandas:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d7e92213-1e16-4d4e-9b35-903c891387e6",
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "7a2e4068-59d8-4997-b0e9-bd67dd240bfb",
   "metadata": {},
   "outputs": [],
   "source": [
    "df = pd.DataFrame(data=[r for r in many_res.rewind()])\n",
    "df.drop('_id', inplace=True, axis=1)\n",
    "df.drop('filename', inplace=True, axis=1)\n",
    "df.drop('slice', inplace=True, axis=1)\n",
    "df.drop('long_name', inplace=True, axis=1)\n",
    "\n",
    "pd.plotting.scatter_matrix(df[['mean', 'dissimilarity', 'correlation', 'digit']], hist_kwds={'bins': 20})\n",
    "df.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a5c0b82e-ce88-4ab1-809f-45deb1105e75",
   "metadata": {},
   "source": [
    "## Query for other meta data.\n",
    "\n",
    "First of all we could have insert the full file. We might have decided to insert only a group content or really all data in the file, thus a recursive run that insert all data. Ok, let's do that:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ade30b7e-615f-4156-b384-f74a0485886d",
   "metadata": {},
   "outputs": [],
   "source": [
    "db = client['h5database_notebook_tutorial']\n",
    "collection_full_digits = db['full_digits']\n",
    "\n",
    "# drop all content in order to start from scratch:\n",
    "collection_full_digits.drop()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6feebeed-ebdd-42d0-9fff-1be69dff35ca",
   "metadata": {},
   "outputs": [],
   "source": [
    "with h5tbx.H5File(filename) as h5:\n",
    "    h5.mongo.insert(collection_full_digits, recursive=True)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "31d27c2d-4a29-4894-bc15-688971057129",
   "metadata": {},
   "source": [
    "The first entry looks like this:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "90701db6-4155-44b5-a064-12a644e215ee",
   "metadata": {},
   "outputs": [],
   "source": [
    "collection_full_digits.find_one({})"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "163d185f-e68e-4f3d-9402-8735dce1751d",
   "metadata": {},
   "source": [
    "It is the data of the root group. It shows all attribute of the group."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "7d537b1b-0652-4267-97a4-702cf2bec06b",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.13"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
